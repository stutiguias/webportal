<!DOCTYPE html>
<html class="no-js">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Request Mail</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width">
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.6.14/dist/vuetify.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 60px;
            padding-bottom: 40px;
        }
    </style>
</head>
<body>
    <div id="app">
        <v-app>
            <!-- Navbar -->
            <v-app-bar app dense dark color="primary">
                <v-toolbar-title>{{ translate('lang1SvName') }}</v-toolbar-title>
                <v-spacer></v-spacer>
                <v-btn text href="index.html">{{ translate('lang1Home') }}</v-btn>
                <v-btn text href="shop.html">{{ translate('lang1Shop') }}</v-btn>

                <!-- Dropdown Menu -->
                <v-menu offset-y>
                    <template v-slot:activator="{ on, attrs }">
                        <v-btn text v-bind="attrs" v-on="on">
                            {{ translate('lang1Settings') }} <v-icon right>mdi-chevron-down</v-icon>
                        </v-btn>
                    </template>
                    <v-list>
                        <v-list-item>
                            <v-list-item-title><a href="myitems.html">{{ translate('lang1MyItems') }}</a></v-list-item-title>
                        </v-list-item>
                        <v-list-item>
                            <v-list-item-title><a href="sell.html">{{ translate('lang1Sell') }}</a></v-list-item-title>
                        </v-list-item>
                        <v-list-item>
                            <v-list-item-title><a href="buy.html">{{ translate('lang1Buy') }}</a></v-list-item-title>
                        </v-list-item>
                        <v-list-item>
                            <v-list-item-title><a href="mail.html">{{ translate('lang1Mail') }}</a></v-list-item-title>
                        </v-list-item>
                        <v-list-item>
                            <v-list-item-title><a href="signs.html">{{ translate('lang1Signs') }}</a></v-list-item-title>
                        </v-list-item>
                        <!-- Outras opções do dropdown -->
                    </v-list>
                </v-menu>

                <v-btn text href="logout">{{ translate('lang1Logout') }}</v-btn>
            </v-app-bar>

            <v-main>
                <v-container>
                    <h2>{{ translate('langMyMail') }}</h2>
                    <v-row>
                        <v-col cols="12" sm="2">
                            <v-avatar size="64">
                                <img :src="avatarUrl" alt="avatar">
                            </v-avatar>
                        </v-col>
                        <v-col cols="12" sm="10">
                            {{ translate('lang1Name') }}: <span>{{ user }}</span> | {{ translate('lang1Money') }}: <span>{{ money }}</span> | {{ translate('lang1Mail') }}: <span>{{ mail }}</span>
                        </v-col>
                    </v-row>
                    <br />
                    <div id="resultado">{{ resultado }}</div>
                    <br />
                    <!-- Tabela de Resultados -->
                    <v-data-table :headers="headers" :items="items" class="mt-5">
                        <template v-slot:item.item_name="{ item }">
                            <div v-html="item.item_name"></div>
                        </template>
                        <template v-slot:item.owner="{ item }">
                            <div v-html="item.owner"></div>
                        </template>
                    </v-data-table>
                    <v-footer fixed>
                        &copy; Made by Stutiguias. Default theme for more usage info visit the <a href="http://dev.bukkit.org/server-mods/webauctionlite">BukkitDev site</a>.
                    </v-footer>
                </v-container>
            </v-main>
        </v-app>
    </div>
    <script src="js/translate.js"></script>
    <script src="js/main.js"></script>
    <script src="js/page/mail.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@2.6.14/dist/vuetify.js"></script>
    <script>
        new Vue({
            el: '#app',
            vuetify: new Vuetify(),
            data() {
                return {
                    from: 0,
                    qtd: 10,
                    user: '',
                    money: '',
                    mail: '',
                    avatarUrl: '',
                    isAdmin: false,
                    resultado: '',
                    headers: [],
                    items: [],
                    sessionid: this.getCookie('sessionid')
                };
            },
            methods: {
                getMail(from, qtd) {
                    fetch(window.qualifyURL(`/mail/get?from=${this.from}&qtd=${this.qtd}&sessionid=${this.sessionid}`))
                        .then(response => {
                        if (!response.ok) {
                            throw new Error('Erro na rede ou resposta não OK');
                        }

                        return response.json();
                        })
                        .then(data => {
                            this.loadTable(data, from, qtd);
                        })
                        .catch(error => {
                            this.resultado = error.message || 'Erro desconhecido';
                        });
                },
                loadTable(data, from, qtd) {
                    if(data[0] != null) return;
                    const firstKey = Object.keys(data).find(key => data[key] instanceof Array && data[key].length > 0);
                    
                    this.headers = Object.values(data[firstKey][0]).map(field => ({
                        text: field.Title,
                        value: field.Title.toLowerCase().replace(/\s+/g, '_')
                    }));
                    this.items = data[firstKey].map(item => {
                        const newItem = {};
                        Object.values(item).forEach(field => {
                            const key = field.Title.toLowerCase().replace(/\s+/g, '_');
                            newItem[key] = field.Val;
                        });
                        return newItem;
                    });
                },
                getCookie(szName) {
                    var szValue = null;
                    if (document.cookie) {
                        var arr = document.cookie.split((escape(szName) + '='));
                        if (2 <= arr.length) {
                            var arr2 = arr[1].split(';');
                            szValue = unescape(arr2[0]);
                        }
                    }
                    return szValue;
                },
                getUserInfo() {
                    fetch(window.qualifyURL("/server/username/info?sessionid=" + this.sessionid))
                    .then(response => response.json())
                    .then(data => {
                        this.user = data["Name"];
                        this.money = data["Money"];
                        this.mail = data["Mail"];
                        this.isAdmin = data["Admin"].toString() === "1";
                        this.avatarUrl = data["Avatarurl"];
                    })
                    .catch(error => {
                        this.user = "Error loading data";
                    });
                },
                translate(key) {
                    return window.langIndex[key] || key;
                },
            },
            mounted() {
                this.getUserInfo();
                this.getMail();
            }
        });
    </script>



  </body>
</html>
