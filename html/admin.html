<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Admin Page</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.6.14/dist/vuetify.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font/css/materialdesignicons.min.css" rel="stylesheet">
</head>
<body>
        <div id="app">
            <v-app>
                <!-- Navbar -->
                <v-app-bar app dense dark color="primary">
                    <v-toolbar-title>{{ translate('lang1SvName') }}</v-toolbar-title>
                    <v-spacer></v-spacer>
                    <v-btn text href="index.html">{{ translate('lang1Home') }}</v-btn>
                    <v-btn text href="shop.html">{{ translate('lang1Shop') }}</v-btn>

                    <!-- Dropdown Menu -->
                    <v-menu offset-y>
                        <template v-slot:activator="{ on, attrs }">
                            <v-btn text v-bind="attrs" v-on="on">
                                {{ translate('lang1Settings') }} <v-icon right>mdi-chevron-down</v-icon>
                            </v-btn>
                        </template>
                        <v-list>
                            <v-list-item>
                                <v-list-item-title><a href="myitems.html">{{ translate('lang1MyItems') }}</a></v-list-item-title>
                            </v-list-item>
                            <v-list-item>
                                <v-list-item-title><a href="sell.html">{{ translate('lang1Sell') }}</a></v-list-item-title>
                            </v-list-item>
                            <v-list-item>
                                <v-list-item-title><a href="buy.html">{{ translate('lang1Buy') }}</a></v-list-item-title>
                            </v-list-item>
                            <v-list-item>
                                <v-list-item-title><a href="mail.html">{{ translate('lang1Mail') }}</a></v-list-item-title>
                            </v-list-item>
                            <v-list-item>
                                <v-list-item-title><a href="signs.html">{{ translate('lang1Signs') }}</a></v-list-item-title>
                            </v-list-item>
                            <!-- Outras opções do dropdown -->
                        </v-list>
                    </v-menu>

                    <v-btn text href="logout">{{ translate('lang1Logout') }}</v-btn>
                </v-app-bar>
                <v-main>
                    <v-container>
                        <v-row>
                            <v-col cols="12" class="text-center">
                                <v-btn-group>
                                    <v-btn @click="listshop" class="replace">{{ translate('langAdmListItem') }}</v-btn>
                                    <v-btn @click="admshop" class="replace">{{ translate('langAdmAddItem') }}</v-btn>
                                    <v-btn @click="infoplayer" class="replace">{{ translate('langPlayerInfo') }}</v-btn>
                                </v-btn-group>
                            </v-col>
                        </v-row>
    
                        <!-- Info Player -->
                        <v-row v-if="showInfoPlayer" align="center" justify="center">
                            <v-col cols="12" sm="6">
                                <v-form @submit.prevent="adm" class="pt-5">
                                    <v-text-field v-model="nick" :label="translate('lang1Name')" placeholder="Insert Name Here"></v-text-field>
                                    <v-select v-model="information" :items="infoOptions" :label="translate('langInfo')"></v-select>
                                    <v-btn type="submit" color="primary">Submit</v-btn>
                                </v-form>
                            </v-col>
                        </v-row>
    
                        <!-- Add Item Shop -->
                        <v-row v-if="showAddItemShop" align="center" justify="center">
                            <v-col cols="12" sm="6">
                                <v-form @submit.prevent="additem" class="pt-5">
                                    <v-text-field v-model="itemId" :label="translate('langItemId')"></v-text-field>
                                    <v-text-field v-model="quantity" :label="translate('langQuantity')" type="number"></v-text-field>
                                    <v-text-field v-model="price" :label="translate('langPrice')" type="number"></v-text-field>
                                    <v-btn type="submit" color="primary">Submit</v-btn>
                                </v-form>
                            </v-col>
                        </v-row>
    
                        <v-alert v-if="resultado" type="info">{{ resultado }}</v-alert>

                        <div v-if="showInfoPlayer" v-for="user in userInfo" :key="user.name">
                            <p>Name: {{ user.name }}</p>
                            <p>Can Buy?: {{ user.canBuy }}</p>
                            <p>Is Admin?: {{ user.isAdmin }}</p>
                            <p>Banned?: {{ user.banned }}</p>
                            <p>IP: {{ user.ip }}</p>
                            <!-- Exibindo o formulário HTML -->
                            <div v-html="user.websiteBanForm"></div>
                        </div>

                        <!-- List Admin Shop -->
                        <v-data-table v-if="showListAdmShop" :headers="tableHeaders" :items="tableItems" class="elevation-1">
                            <template v-slot:item.item_name="{ item }">
                                <div v-html="item.item_name"></div>
                            </template>
                            <template v-slot:item.delete="{ item }">
                                <v-btn icon @click="deleteItem(item.delete)">
                                    <v-icon>mdi-delete</v-icon>
                                </v-btn>
                            </template>
                        </v-data-table>
                    </v-container>
                </v-main>
            </v-app>
        </div>
    
        <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/vuetify@2.6.14/dist/vuetify.js"></script>
        <script src="js/translate.js"></script>
        <script src="js/main.js"></script>
        <!--<script src="js/page/admin.js"></script>-->
        <script>
            const vue = new Vue({
                el: '#app',
                vuetify: new Vuetify(),
                data: () => ({
                    to: 0,
                    from: 10,
                    showInfoPlayer: false,
                    showAddItemShop: false,
                    showListAdmShop: false,
                    nick: '',
                    information: '',
                    infoOptions: [
                        { text: 'Player Info', value: 'playerinfo' },
                        { text: 'Player Items', value: 'playeritems' },
                        // Complete with other options
                    ],
                    itemId: '',
                    quantity: '',
                    price: '',
                    resultado: '',
                    tableHeaders: [
                        { text: 'Delete', value: 'delete', sortable: false },
                        { text: 'Item Name', value: 'item_name' },
                        { text: 'Price', value: 'price' },
                        { text: 'Quantity', value: 'quantity' }
                    ],
                    tableItems: [],
                    userInfo: []
                }),
                methods: {
                    async get(url) {
                        try {
                            const response = await fetch(window.qualifyURL(url));
                            const data = await response.json();
                            this.processData(data);
                        } catch (error) {
                            this.resultado = error;
                        }
                    },
                    processData(data) {
                        this.loadTable(data)
                    },
                    loadTable(data, from, qtd) {
                        if(data[0] != null) return;
                        const firstKey = Object.keys(data).find(key => Array.isArray(data[key]) && data[key].length > 0);
                        if (firstKey) {
                            this.tableItems = data[firstKey].map(item => {
                                return {
                                    delete: this.extractIdFromDeleteForm(item.Delete), 
                                    item_name: item["Item Name"], // Extrai o texto do nome do item
                                    price: item.Price,
                                    quantity: item.Quantity
                                };
                            });
                        }
                    },
                    extractIdFromDeleteForm(htmlString) {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(htmlString, 'text/html');
                        const input = doc.querySelector("input[type='hidden'][name='ID']");
                        return input ? input.value : null;
                    },
                    getCookie(szName) {
                        var szValue = null;
                        if (document.cookie) {
                            var arr = document.cookie.split((escape(szName) + '='));
                            if (2 <= arr.length) {
                                var arr2 = arr[1].split(';');
                                szValue = unescape(arr2[0]);
                            }
                        }
                        return szValue;
                    },
                    translate(key) {
                        return window.langIndex[key] || key;
                    },
                    listshop() {
                        this.resultado = null;
                        this.showListAdmShop = true;
                        this.showAddItemShop = false;
                        this.showInfoPlayer = false;
                        this.get("/adm/shoplist?&DisplayStart=" + this.to + "&DisplayLength=" + this.from + "&sessionid=" + this.getCookie("sessionid"));
                    },
                    admshop() {
                        this.resultado = null;
                        this.showAddItemShop = true;
                        this.showListAdmShop = false;
                        this.showInfoPlayer = false;
                        
                    },
                    infoplayer() {
                        this.resultado = null;
                        this.showInfoPlayer = true;
                        this.showListAdmShop = false;
                        this.showAddItemShop = false;
                        
                    },
                    async deleteItem(itemId) { 
                        const response = await fetch(window.qualifyURL("/adm/deleteshop?ID=" + itemId + "&sessionid=" + this.getCookie("sessionid")));
                        const data = await response.text();
                        this.resultado = data;
                    },
                    async adm() {
                        console.log("Fetching player info:", this.nick, "Info type:", this.information);
                        const response = await fetch(window.qualifyURL("/adm/search?nick=" + this.nick + "&information=" + this.information + "&sessionid=" + this.getCookie("sessionid")));
                        const data = await response.json();
                        this.userInfo = data.map(user => ({
                            banned: user["Banned ?"],
                            canSell: user["Can Sell ?"],
                            isAdmin: user["is Admin ?"],
                            ip: user["Ip"],
                            canBuy: user["Can Buy ?"],
                            name: user["Name"],
                            websiteBanForm: user["WebSite Ban"]
                        }));
                    },
                    async additem() {
                        console.log("Adding item to shop:", this.itemId, "Quantity:", this.quantity, "Price:", this.price);
                        const response = await fetch(window.qualifyURL("/adm/addshop?&itemId=" + this.itemId + "&quantity=" + this.quantity + "&price=" + this.price + "&sessionid=" + this.getCookie("sessionid")));
                        const data = await response.text();
                        this.resultado = data;
                        this.resetAddItemForm();
                    },
                    resetAddItemForm() {
                        this.itemId = '';
                        this.quantity = '';
                        this.price = '';
                    },
                    async websiteban(formEvent) {
                        try {
                            let formDataObj = {};
                            for (let element of event.target.elements) {
                                if (element.name && element.value) {
                                    formDataObj[element.name] = element.value;
                                }
                            }
                            formDataObj['sessionid'] = this.getCookie("sessionid");
                            const params = new URLSearchParams(formDataObj);
                            const url = window.qualifyURL("/adm/webban") + "?" + params.toString();

                            try {
                                const response = await fetch(url);

                                if (!response.ok) {
                                    throw new Error(`HTTP error! status: ${response.status}`);
                                }

                                const data = await response.text();
                                this.resultado = data; // Supondo que 'resultado' seja uma propriedade reativa para exibir a resposta
                            } catch (error) {
                                this.resultado = 'Error: ' + error.message;
                            }

                        } catch (error) {
                            this.resultado = 'Error: ' + error.message;
                        }
                    },
                    async websiteunban(formEvent) {
                        try {
                            let formDataObj = {};
                            for (let element of event.target.elements) {
                                if (element.name && element.value) {
                                    formDataObj[element.name] = element.value;
                                }
                            }
                            formDataObj['sessionid'] = this.getCookie("sessionid");
                            const params = new URLSearchParams(formDataObj);
                            const url = window.qualifyURL("/adm/webunban") + "?" + params.toString();

                            try {
                                const response = await fetch(url);

                                if (!response.ok) {
                                    throw new Error(`HTTP error! status: ${response.status}`);
                                }

                                const data = await response.text();
                                this.resultado = data; // Supondo que 'resultado' seja uma propriedade reativa para exibir a resposta
                            } catch (error) {
                                this.resultado = 'Error: ' + error.message;
                            }

                        } catch (error) {
                            this.resultado = 'Error: ' + error.message;
                        }
                    },

                },
                mounted() {
                // Aqui você pode inicializar componentes da página ou buscar dados iniciais
                // Por exemplo, buscar a lista de itens do shop para exibir no "List Admin Shop"
                // this.fetchShopItems();
                }
            });

            window.vueApp = vue;
            function websiteban(form) {
                window.vueApp.websiteban(form);   
                return false;
            }

            function websiteunban(form) {
                window.vueApp.websiteunban(form);
                return false;
            }
    </script>

  </body>
</html>
